# Changelog

All notable changes to this project will be documented in this file.
This file follows the [Keep a Changelog](https://keepachangelog.com/en/1.0.0/) format
and adheres to [SemVer](https://semver.org/) versioning.

---

## [0.14.1] - 2026-02-11

### Added

- **Typed Functions API in Notebook** â€” Added Section 1 to `examples/08_computed_functions.ipynb`
  - `db.fn.math.*` â€” `sqrt`, `pow`, `abs`, `ceil` demos
  - `db.fn.string.*` â€” `uppercase`, `len`, `concat` demos
  - `db.fn.time.*` â€” `now()` server timestamp demo
  - `db.fn.crypto.*` â€” `sha256`, `md5`, `argon2.generate` demos
  - `db.fn.array.*` â€” `len`, `distinct`, `flatten` demos
  - Dynamic namespace resolution demo (`db.fn.rand.int`)
  - SQL inspection via `FunctionCall.to_sql()`

### Changed

- Notebook `08_computed_functions.ipynb` reordered from simple to complex (Typed Functions API first)
- Sections renumbered: Typed Functions (1) â†’ Computed Fields (2) â†’ SurrealFunc (3) â†’ extra_vars (4) â†’ call_function (5) â†’ raw_query (6)
- Version bump to 0.14.1

---

## [0.14.0] - 2026-02-11

### Added

- **Test Fixtures** â€” Declarative test data with automatic cleanup
  - `SurrealFixture` base class for declaring fixtures as class attributes
  - `@fixture` decorator scans class attributes for `BaseSurrealModel` instances
  - `load()` async context manager: saves all instances on enter, deletes them on exit
  - Fixture instances accessible by attribute name (e.g., `fixtures.alice`)
  - Deep-copies templates on each `load()` to avoid state leakage across calls
  - Duck-type detection for cross-import-path compatibility
  - New file: `src/surreal_orm/testing/fixtures.py`

- **Model Factories** â€” Factory Boy-style data generation with zero external dependencies
  - `ModelFactory` with `_FactoryMeta` metaclass for declarative factory definitions
  - `build()` / `build_batch(n)` â€” create in-memory instances (unit tests, no DB)
  - `create()` / `create_batch(n)` â€” create and save to DB (integration tests)
  - Override any field at call time: `create(role="admin")`
  - Built-in `Faker` with 14 providers: `name`, `first_name`, `last_name`, `email`, `random_int`, `random_float`, `text`, `sentence`, `word`, `uuid`, `boolean`, `date`, `datetime`, `choice`
  - New file: `src/surreal_orm/testing/factories.py`

- **QueryLogger** â€” Profile and debug all ORM queries with timing
  - `QueryLog` dataclass: `sql`, `variables`, `duration_ms`, `timestamp`
  - `QueryLogger` async context manager with `total_queries` and `total_ms` properties
  - Async-safe activation via `contextvars.ContextVar`
  - All query paths instrumented: `QuerySet.exec()`, `save()`, `update()`, `merge()`, `delete()`, `raw_query()`, `atomic_append/remove/set_add()`
  - New file: `src/surreal_orm/debug.py`

- **Testing Subpackage** â€” `surreal_orm.testing` with public exports
  - `from surreal_orm.testing import SurrealFixture, fixture, ModelFactory, Faker`
  - New file: `src/surreal_orm/testing/__init__.py`

- **15 Themed Jupyter Notebooks** â€” Comprehensive examples in `examples/`
  - `00_setup` â€” Prerequisites, Docker, connection config
  - `01_models_crud` â€” Model definition, CRUD operations
  - `02_queries_filters` â€” Filters, Q objects, lookups
  - `03_aggregations` â€” Count, Sum, Avg, Min, Max, GROUP BY
  - `04_relations_graph` â€” ForeignKey, ManyToMany, graph traversal
  - `05_transactions_bulk` â€” Transactions, bulk operations, atomic ops
  - `06_signals` â€” Pre/post/around signals
  - `07_auth` â€” User tables, signup, signin, token validation
  - `08_computed_functions` â€” Computed fields, SurrealFunc, raw_query
  - `09_advanced_queries` â€” Subqueries, QueryCache
  - `10_search_vectors` â€” Vector search, full-text search, hybrid search
  - `11_geospatial` â€” GeoField, PointField, nearby(), GeoDistance
  - `12_realtime` â€” Live queries, change feeds
  - `13_migrations_schema` â€” Migration system, schema introspection
  - `14_testing_debug` â€” SurrealFixture, ModelFactory, QueryLogger

- **Shared Test Connection Constants** â€” Centralized in `tests/conftest.py`
  - `SURREALDB_URL`, `SURREALDB_WS_URL`, `SURREALDB_USER`, `SURREALDB_PASS`, `SURREALDB_NAMESPACE`
  - All env-variable-backed with sensible defaults
  - `SURREALDB_SKIP_CONTAINER` support for CI environments

### Changed

- Alpha â†’ Beta transition (`Development Status :: 4 - Beta` classifier)
- `conftest.py` uses `/health` endpoint as primary readiness signal (no longer requires Docker container name check)
- `QuerySet.nearby()` validates coordinate types and tuple length
- `SurrealFixture.load()` uses `object.__new__(cls)` to avoid type checker warnings
- Version bump to 0.14.0

### Fixed

- **Notebook 05** â€” `async with SurrealDBConnectionManager.transaction()` â†’ `async with await` (coroutine needs `await` before entering context manager)
- **Notebook 09** â€” `annotate()` with `Subquery` returns dicts via GROUP ALL path; rewrote to use `values().annotate()` pattern
- **Notebook 11** â€” SurrealDB cannot parse `$variable` references inside tuple constructors; geo coordinates now inlined in query string
- **Notebook 14** â€” `@fixture` decorator `isinstance()` failed across dual-import paths; added duck-type fallback check
- **CI pipeline** â€” Docker Compose service name `surrealdb-ci` â†’ `surrealdb`
- Hardcoded URLs/credentials in 6 test files replaced with shared `conftest` constants

---

## [0.13.0] - 2026-02-10

### Added

- **DEFINE EVENT (Server-Side Triggers)** â€” Declarative server-side event triggers in migrations
  - `DefineEvent(name, table, when, then)` migration operation â€” generates `DEFINE EVENT ... WHEN ... THEN (...);`
  - `RemoveEvent(name, table)` migration operation
  - `EventState` dataclass for schema tracking
  - `parse_define_event()` parser for `DEFINE EVENT` statements
  - `SchemaState.diff()` detects event add/change/remove across tables
  - `DatabaseIntrospector` parses events from `INFO FOR TABLE`
  - `ModelCodeGenerator` adds informational event comments in generated models

- **Geospatial Fields & Queries** â€” Typed geometry fields and distance-based queries
  - `GeoField["point"]`, `GeoField["polygon"]`, `GeoField["linestring"]`, `GeoField["multipoint"]` type annotations
  - Convenience aliases: `PointField`, `PolygonField`, `LineStringField`, `MultiPointField`
  - `is_geo_field()` and `get_geo_info()` detection helpers
  - `QuerySet.nearby(field, point, max_distance)` â€” proximity filter using `geo::distance()`
  - `GeoDistance(field, point)` annotation helper â€” compatible with `annotate()` interface
  - `ModelCodeGenerator` generates `GeoField["X"]` for `geometry<X>` database types
  - New files: `src/surreal_orm/fields/geometry.py`, `src/surreal_orm/geo.py`

- **Materialized Views** â€” Read-only models backed by `DEFINE TABLE ... AS SELECT`
  - `SurrealConfigDict(view_query="SELECT ...")` for view configuration
  - Read-only guard: `save()`, `update()`, `merge()`, `delete()` raise `TypeError` on views
  - `CreateTable(view_query=...)` generates `DEFINE TABLE ... AS (...);`
  - `parse_define_table()` extracts `AS` clause as `view_query`
  - `SchemaState.diff()` detects view_query changes

- **TYPE RELATION Enforcement** â€” Graph edge constraints in migrations
  - `TableType.RELATION` and `TableType.ANY` added to enum
  - `SurrealConfigDict(relation_in=..., relation_out=..., enforced=True)` for relation config
  - `CreateTable` generates `TYPE RELATION IN table1 OUT table2 ENFORCED`
  - `parse_define_table()` extracts RELATION IN/OUT/ENFORCED clauses
  - `DatabaseIntrospector` populates relation fields from schema

### Changed

- `annotate()` type hint extended to accept `GeoDistance`
- `exec()` integrates geo distance WHERE clause in `_compile_query()`
- `ModelCodeGenerator` generates `view_query=`, `relation_in=`, `relation_out=`, `enforced=` in config
- Version bump to 0.13.0

---

## [0.12.0] - 2026-02-10

### Added

- **Vector Search** â€” First-class support for AI/RAG pipelines with SurrealDB HNSW indexes
  - `VectorField[dimension]` and `VectorField[dimension, "type"]` type annotations
  - `is_vector_field()` and `get_vector_info()` detection helpers
  - `QuerySet.similar_to(field, vector, limit, *, ef)` â€” KNN similarity search using `<|N|>` operator
  - Auto-adds `vector::distance::knn() AS _knn_distance` to SELECT and ORDER BY
  - Combined with `.filter()` for pre-filtered similarity search
  - New file: `src/surreal_orm/fields/vector.py`

- **Full-Text Search** â€” BM25 scoring, highlighting, and multi-field search
  - `QuerySet.search(**field_queries)` â€” FTS using `@N@` match operator
  - `SearchScore(ref)` â€” Annotation helper for `search::score(N)` BM25 relevance
  - `SearchHighlight(open_tag, close_tag, ref)` â€” Annotation helper for `search::highlight()`
  - Multi-field search with auto-incrementing match references
  - Compatible with `.filter()` and `.annotate()` for combined queries
  - New file: `src/surreal_orm/search.py`

- **Hybrid Search** â€” Reciprocal Rank Fusion combining vector + full-text search
  - `QuerySet.hybrid_search(vector_field, vector, text_field, text_query, ...)` â€” Uses `search::rrf()` for ranking fusion
  - Configurable `vector_limit`, `text_limit`, `rrf_k` parameters

- **HNSW Index Support** â€” Full migration support for vector indexes
  - `CreateIndex` expanded with `hnsw`, `dimension`, `dist`, `vector_type`, `efc`, `m`, `concurrently` parameters
  - Generates `DEFINE INDEX ... HNSW DIMENSION N DIST X TYPE Y EFC N M N;`
  - `IndexState` expanded with all HNSW parameters for schema diffing

- **Full-Text Index Support** â€” BM25 and highlights in migrations
  - `CreateIndex` expanded with `bm25` (bool or tuple) and `highlights` parameters
  - Generates `DEFINE INDEX ... SEARCH ANALYZER name BM25(k1, b) HIGHLIGHTS;`

- **Analyzer Operations** â€” Define and manage custom text analyzers
  - `DefineAnalyzer(name, tokenizers, filters)` migration operation
  - `RemoveAnalyzer(name)` migration operation
  - `AnalyzerState` dataclass for schema tracking
  - `SchemaState.analyzers` dict with full diff support (add/update/remove)
  - `parse_define_analyzer()` parser for `DEFINE ANALYZER` statements

- **Parser Enhancements** â€” `parse_define_index()` now parses HNSW, BM25, HIGHLIGHTS, CONCURRENTLY

- **Introspection Updates**
  - `DatabaseIntrospector` now parses analyzers from `INFO FOR DB`
  - `ModelCodeGenerator` generates `VectorField[dim]` annotations for HNSW-indexed fields

### Changed

- `annotate()` type hint extended to accept `SearchScore | SearchHighlight`
- `exec()` attaches extra fields (`_knn_distance`, search scores) to model instances
- Search-only annotations bypass GROUP BY path in `_execute_annotate()`
- Version bump to 0.12.0

---

## [0.11.0] - 2026-02-10

### Added

- **Subqueries** â€” Embed a QuerySet as a filter value in another QuerySet
  - `Subquery` class wrapping a `QuerySet` for inline sub-SELECT expressions
  - Parameterized variables remapped via shared counter to avoid collisions
  - Works with all filter operators (`__in`, `=`, etc.) and Q objects
  - Nested subqueries supported (subquery within a subquery)
  - Usable in `annotate()` for scalar sub-SELECT expressions
  - New file: `src/surreal_orm/subquery.py`

- **Query Cache** â€” TTL-based query result caching with auto-invalidation
  - `QueryCache` class-level singleton with `configure()`, `get()`, `set()`, `invalidate()`, `clear()`, `stats()`
  - SHA-256 cache keys from query string + variables + table name
  - FIFO eviction when `max_size` is reached
  - Auto-invalidation via `post_save`, `post_delete`, `post_update` signals
  - `QuerySet.cache(ttl=N)` method for opt-in caching per query
  - New file: `src/surreal_orm/cache.py`

- **Prefetch Objects** â€” Fine-grained control over `prefetch_related()` batching
  - `Prefetch` class with `relation_name`, `queryset`, and `to_attr` parameters
  - `prefetch_related()` now accepts both strings and `Prefetch` objects
  - `_execute_prefetch()` batch-fetches related records after main query
  - Results attached to parent instances via `object.__setattr__`
  - Custom QuerySet filters applied to the edge table query
  - New file: `src/surreal_orm/prefetch.py`

### Changed

- `annotate()` type hint extended to accept `Aggregation | Subquery`
- `_execute_annotate()` handles Subquery annotations as inline sub-SELECTs
- `_prefetch_related` type changed from `list[str]` to `list[str | Prefetch]`
- `exec()` now checks/stores cache and runs prefetch after main query
- Version bump to 0.11.0

---

## [0.10.0] - 2026-02-10

### Added

- **Schema Introspection** â€” Generate Python model code from an existing SurrealDB database
  - `generate_models_from_db(output_path=)` public API
  - `schema_diff(models=[...])` to compare Python models against live database
  - `DatabaseIntrospector` â€” Parses `INFO FOR DB` / `INFO FOR TABLE` into `SchemaState`
  - `ModelCodeGenerator` â€” Converts `SchemaState` to Python model source code
  - `define_parser` module â€” Parses DEFINE TABLE, FIELD, INDEX, ACCESS statements
  - Handles generic types, VALUE/ASSERT expressions, encrypted fields, FLEXIBLE, READONLY
  - CLI: `surreal-orm inspectdb` and `surreal-orm schemadiff` commands

- **Multi-Database Support** â€” Named connection registry for routing models to different databases
  - `ConnectionConfig` frozen dataclass for immutable connection settings
  - `add_connection("name", ...)` to register named connections
  - `using("name")` async context manager override (async-safe via `contextvars`)
  - `SurrealConfigDict(connection="name")` model-level connection routing
  - `get_connection_name()` priority: context var > model config > `"default"`
  - `list_connections()`, `get_config()`, `remove_connection()` registry management
  - Full backward compatibility: `set_connection()` delegates to `add_connection("default", ...)`

### Changed

- All query paths route through named connection (model, queryset, live, auth, relations)
- Version bump to 0.10.0

---

## [0.9.0] - 2026-02-10

### Added

- **Live Models** â€” ORM-level real-time subscriptions via WebSocket Live Queries
  - `QuerySet.live()` returns a typed async iterator yielding `ModelChangeEvent` instances
  - `ModelChangeEvent[T]` dataclass with `action`, `instance: T`, `record_id`, `changed_fields`, `raw`
  - `LiveModelStream[T]` async context manager + iterator wrapping SDK `LiveSelectStream`
  - Filter integration: QuerySet filters translate to live query WHERE clauses
  - `auto_resubscribe=True` for seamless WebSocket recovery
  - `diff=True` for receiving only changed fields (DIFF mode)

- **Change Feed Integration** â€” HTTP-based change data capture at the ORM level
  - `QuerySet.changes()` returns a typed async iterator for event streaming
  - `ChangeModelStream[T]` async iterator wrapping SDK `ChangeFeedStream`
  - Cursor tracking via `.cursor` property for resumable streaming
  - Configurable `poll_interval` and `batch_size` parameters

- **`post_live_change` Signal** â€” New signal fired on live query events

- **WebSocket Connection Manager** â€” Lazy WebSocket connection alongside HTTP
  - `SurrealDBConnectionManager.get_ws_client()` for manual access

### Changed

- Version bump to 0.9.0

---

## [0.8.0] - 2026-02-08

### Added

- **Computed Fields** â€” Server-side computed fields using `DEFINE FIELD ... VALUE <expression>`
  - `Computed[T] = Computed("expression")` â€” dual-use type annotation + default value
  - Auto-excluded from writes via `get_server_fields()`
  - Migration introspector generates VALUE clauses

### Fixed

- **Auth Module: Ephemeral Connections** (Critical) â€” `signup()`, `signin()`, `authenticate_token()` no longer mutate root singleton connection
- **Auth Module: Configurable Access Name** (High) â€” Access name configurable via `access_name` in `SurrealConfigDict`
- **Auth Module: `signup()` Returns Token** (High) â€” Now returns `tuple[Self, str]` (user + JWT)
- **Auth Module: `authenticate_token()` Fixed** (Medium) â€” Now returns `tuple[Self, str] | None`
  - Added `validate_token()` lightweight method returning `str | None`
  - SDK `authenticate()` RPC method added to `BaseSurrealConnection`

### Changed

- Version bump to 0.8.0

---

## [0.7.0] - 2026-02-08

### Added

- **`merge(refresh=False)`** â€” Skip the extra SELECT after UPDATE for fire-and-forget operations
- **`call_function()`** â€” Invoke custom SurrealDB stored functions from ORM
  - Available on `SurrealDBConnectionManager` and any model class
- **`extra_vars` on `save()` and `merge()`** â€” Bind additional query variables for SurrealFunc expressions
- **`fetch()` + FETCH clause** â€” Resolve record links inline to avoid N+1 queries
  - `select_related()` also maps to FETCH
- **`remove_all_relations()` with list support** â€” Remove multiple relation types in one call

### Changed

- Version bump to 0.7.0

---

## [0.6.0] - 2026-02-07

### Added

- **Q Objects for Complex Queries** - Django-style composable query expressions
  - `Q` class with `|` (OR), `&` (AND), and `~` (NOT) operators
  - Mix Q objects with regular kwargs in `filter()` calls
  - Recursive rendering of nested Q trees into SurrealQL WHERE clauses
  - New file: `src/surreal_orm/q.py`

- **Parameterized Filters (Security)** - All filter values bound as query variables
  - Filter values use `$_fN` auto-generated variable names instead of `repr()` string interpolation
  - Prevents SQL injection by never embedding values directly in query strings
  - Existing `$variable` references via `.variables()` remain fully backwards compatible
  - New shared `_render_condition()` method factored from `_compile_query()` and `_compile_where_clause()`

- **SurrealFunc for Server-Side Functions** - Embed raw SurrealQL expressions in save/update
  - `SurrealFunc(expression)` marker class for server-side function calls
  - `save(server_values={"field": SurrealFunc("time::now()")})` for save operations
  - `merge(field=SurrealFunc("time::now()"))` with automatic detection
  - `_build_set_clause()` helper generates `SET field = expression` with mixed parameterized/raw values
  - Falls back to raw `UPSERT/UPDATE ... SET ...` query when SurrealFunc values are present

- **`remove_all_relations()`** - Bulk relation deletion on model instances
  - `direction` parameter: `"out"` (default), `"in"`, or `"both"`
  - Transaction support via `tx` parameter
  - Identifier validation with `_SAFE_IDENTIFIER_RE`
  - Proper ID escaping with `format_thing()`

- **Django-style `-field` Ordering** - Shorthand for descending order
  - `order_by("-created_at")` is equivalent to `order_by("created_at", OrderBy.DESC)`
  - Fully backwards compatible: existing `order_by("field", OrderBy.DESC)` still works

### Fixed

- **`isnull` Lookup** - `filter(field__isnull=True)` now generates `field IS NULL` instead of `field IS True`
  - `filter(field__isnull=False)` correctly generates `field IS NOT NULL`

### Changed

- `_compile_query()` and `_compile_where_clause()` now use shared `_build_where_parts()` method
- Filter rendering extracted into `_render_condition()` static method (was duplicated)
- `_render_q()` added for recursive Q object compilation
- Version bump to 0.6.0

---

## [0.5.9] - 2026-02-07

### Added

- **Atomic Array Operations** â€” Server-side array mutations
  - `atomic_append(record_id, field, value)` â€” Append using `array::append()`
  - `atomic_remove(record_id, field, value)` â€” Remove using `-=` operator
  - `atomic_set_add(record_id, field, value)` â€” Add only if not present using `+=`

- **Transaction Conflict Retry** â€” `retry_on_conflict(max_retries=3)` decorator with exponential backoff + jitter
  - `TransactionConflictError` new exception subclass for conflict detection

- **Relation Direction Control** â€” `reverse` parameter for `relate()` and `remove_relation()`

- **New Query Lookup Operators**
  - `not_contains` â†’ `CONTAINSNOT`
  - `containsall` â†’ `CONTAINSALL`
  - `containsany` â†’ `CONTAINSANY`
  - `not_in` â†’ `NOT IN`

### Changed

- Version bump to 0.5.9

---

## [0.5.8] - 2026-02-05

### Added

- **Around Signals** â€” Generator-based middleware pattern for wrapping DB operations
  - `around_save`, `around_delete`, `around_update` signal types
  - Shared state between before/after logic via `yield`
  - Guaranteed cleanup with `try/finally`
  - Execution order: `pre_* â†’ around(before) â†’ DB operation â†’ around(after) â†’ post_*`

### Changed

- Version bump to 0.5.8

---

## [0.5.7] - 2026-02-05

### Added

- **Model Signals** â€” Django-style event hooks for model lifecycle operations
  - Signal types: `pre_save`, `post_save`, `pre_delete`, `post_delete`, `pre_update`, `post_update`
  - `Signal.connect(sender=None)` decorator and method for registering handlers
  - `Signal.send(sender, **kwargs)` for dispatching to handlers
  - `Signal.disconnect()`, `Signal.disconnect_all()`, `Signal.clear()` for cleanup

### Changed

- Version bump to 0.5.7

---

## [0.5.6] - 2026-02-04

### Fixed

- **Issue #8 bis: Numeric ID escaping in relation queries**
  - Fixed `get_related()`, `RelationQuerySet`, and `RelationInfo.get_traversal_query()` for IDs starting with digits
  - Now uses `escape_record_id()` for proper backtick escaping in graph traversal queries

### Changed

- Version bump to 0.5.6

---

## [0.5.5.3] - 2026-02-04

### Fixed

- **Issue #10: RecordId objects in non-id fields not converted to strings**
  - When using CBOR protocol, foreign key fields (like `user_id`, `table_id`) returned `RecordId` objects instead of strings
  - This caused Pydantic validation errors and application failures
  - Fix: `_preprocess_db_record()` now converts RecordId objects in ANY field to strings
  - For the `id` field: extracts just the id part (e.g., `"abc123"`)
  - For other fields: converts to "table:id" format (e.g., `"users:abc123"`)

### Changed

- `_convert_record_id_to_string()` - New helper function for converting RecordId objects
- `_update_from_db()` now also handles RecordId conversion in non-id fields
- Version bump to 0.5.5.3

---

## [0.5.5.2] - 2026-02-04

### Fixed

- **Issue #9 (CRITICAL): datetime_type Pydantic validation regression**
  - In v0.5.5.1, records with datetime fields failed Pydantic validation
  - `from_db()` silently returned dicts instead of model instances
  - Caused widespread application failures ("'dict' object has no attribute 'model_dump'")
  - Root cause: `from_db()` passed raw database data directly to Pydantic without preprocessing
  - Fix: Added `_preprocess_db_record()` method to handle datetime parsing and RecordId conversion

### Added

- **`BaseSurrealModel._preprocess_db_record()`** - New classmethod that preprocesses database records
  - Parses datetime fields in all formats:
    - ISO 8601 strings (JSON protocol)
    - Python datetime objects (CBOR protocol)
    - CBOR timestamp arrays `[seconds, nanoseconds]`
  - Converts RecordId objects from CBOR responses to string IDs
  - Called by `from_db()` before Pydantic validation

### Changed

- `from_db()` now uses `_preprocess_db_record()` for consistent handling with `_update_from_db()`
- Version bump to 0.5.5.2

---

## [0.5.5.1] - 2026-02-04

### Fixed

- **Issue #8 (CRITICAL): Record IDs starting with digits** - IDs like `7abc123` now properly escaped
  - SurrealDB interprets unquoted IDs starting with digits as number tokens, causing parse errors
  - New `escape_record_id()` utility escapes such IDs with backticks: `` `7abc123` ``
  - New `format_thing()` utility generates correct thing references: `` table:`7abc123` ``
  - All CRUD operations (`get()`, `save()`, `update()`, `merge()`, `delete()`) use proper escaping

- **Issue #3 (HIGH): CBOR protocol for HTTP connections**
  - HTTP connections now support and default to CBOR protocol
  - Fixes `data:` prefix strings being misinterpreted as record links
  - `HTTPConnection` accepts `protocol` parameter: `"cbor"` (default) or `"json"`
  - `SurrealDBConnectionManager.set_connection()` accepts `protocol` parameter

- **Issue #1 (HIGH): `QuerySet.get()` handles full record ID format**
  - `get("table:id")` now correctly extracts the ID part and queries the correct table
  - New `parse_record_id()` utility handles both formats: `"abc123"` and `"table:abc123"`
  - Handles escaped IDs correctly: `` "table:`7abc`" `` â†’ `"7abc"`

- **Issue #7 (MEDIUM): `get_related()` with `direction="in"` returns correct results**
  - Changed from unreliable `SELECT ... FETCH` to `SELECT VALUE field.* FROM ... WHERE ...`
  - Both `direction="in"` and `direction="out"` now return full related records

- **`update()` table name bug** - Fixed incidental bug using class name instead of `table_name`
  - Was using `self.__class__.__name__` instead of `self.get_table_name()`
  - Models with custom `table_name` config now update correctly

### Added

- **New utility module** - `src/surreal_orm/utils.py` with record ID handling functions:
  - `needs_id_escaping(record_id)` - Check if ID needs backtick escaping
  - `escape_record_id(record_id)` - Escape ID with backticks if needed
  - `format_thing(table, record_id)` - Generate proper SurrealDB thing reference
  - `parse_record_id(full_id)` - Parse `table:id` format into components

### Changed

- HTTP connections default to CBOR protocol (same as WebSocket)
- All ORM CRUD methods use `format_thing()` for consistent ID handling
- Version bump to 0.5.5.1

---

## [0.5.5] - 2026-02-03

### Added

- **CBOR Protocol Support** - Binary protocol for WebSocket connections (Issue #3)
  - `cbor2` is now a **required dependency** (previously optional)
  - CBOR is the **default protocol** for WebSocket connections
  - Properly handles strings with `data:` prefix (no longer misinterpreted as record links)
  - Custom CBOR tags for SurrealDB types: `RecordId`, `Table`, `Duration`, `DateTime`, `UUID`, `Decimal`
  - `RPCRequest.to_cbor()` and `RPCResponse.from_cbor()` methods
  - Aligns with official SurrealDB SDK protocol behavior

- **`unset_connection_sync()` Method** (Issue #4)
  - Synchronous version of `unset_connection()` for non-async contexts
  - Useful in `atexit` handlers, `__del__` methods, and synchronous cleanup code
  - Clears connection settings without async `close()` call

- **Field Alias Support** (Issue #6)
  - Map Python field names to different database column names
  - Uses Pydantic `Field(alias="db_column_name")` syntax
  - `populate_by_name=True` set by default in `BaseSurrealModel`
  - All `model_dump()` calls use `by_alias=True` for database operations

### Changed

- **CBOR is now required** - `cbor2>=5.6.0` moved from optional to required dependency
- **CBOR is the default protocol** - WebSocket connections use `protocol="cbor"` by default
- Removed `[cbor]` optional extra from `pyproject.toml`
- Updated `WebSocketConnection` docstring to reflect CBOR as recommended protocol
- Version bump to 0.5.5

### Fixed

- **Issue #3** - Strings with `data:` prefix (like base64 images) no longer misinterpreted as record links
  - JSON protocol interprets `data:xxx` as `record<data>` type
  - CBOR protocol properly encodes strings without interpretation

---

## [0.5.4] - 2026-02-03

### Added

- **Record ID format handling** - `QuerySet.get()` now automatically handles both formats:
  - Just the ID: `get("abc123")`
  - Full SurrealDB format: `get("players:abc123")`

- **`remove_relation()` accepts string IDs** - Now accepts both model instances and string IDs:
  - Model instance: `await table.remove_relation("has_player", player_instance)`
  - String ID (full format): `await table.remove_relation("has_player", "players:abc123")`
  - String ID (just ID): `await table.remove_relation("has_player", "abc123")`

- **`raw_query()` class method** - Execute arbitrary SurrealQL queries from model class

### Changed

- Version bump to 0.5.4

---

## [0.5.3.3] - 2026-02-02

### Fixed

- **`from_db()` fields_set** â€” Fixed bug where `from_db()` marked all fields as "user-set", causing `exclude_unset=True` to include DB-loaded fields in subsequent saves. Now `from_db()` clears `__pydantic_fields_set__`.

### Changed

- Version bump to 0.5.3.3

---

## [0.5.3.2] - 2026-02-02

### Fixed

- **QuerySet table name** â€” Fixed critical bug where QuerySet used class name instead of configured `table_name` from `model_config`

### Changed

- `QuerySet.get()` signature now accepts both `id=` keyword and positional `id_item` parameter
- Version bump to 0.5.3.2

---

## [0.5.3.1] - 2026-02-02

### Fixed

- **Partial updates for persisted records** â€” `save()` now uses `merge()` for already-persisted records, only sending explicitly modified fields
- **datetime parsing from DB** â€” `_update_from_db()` auto-parses ISO 8601 datetime strings
- **`_db_persisted` flag** â€” Tracks new vs persisted records for correct save behavior

### Changed

- Version bump to 0.5.3.1

---

## [0.5.3] - 2026-02-02

### Added

- **`upsert()` Method** - New SDK method for create-or-update operations
  - Added to `BaseSurrealConnection` and all transaction types
  - Enables idempotent save behavior for existing records

- **`server_fields` Config Option** - Exclude server-generated fields from saves
  - New `server_fields` option in `SurrealConfigDict`
  - Automatically excludes fields like `created_at`, `updated_at` from save/update
  - Prevents datetime serialization errors on subsequent saves

- **`_update_from_db()` Helper** - Internal method for DB data loading
  - Updates model fields without marking them as user-set
  - Preserves `__pydantic_fields_set__` for correct `exclude_unset` behavior

### Fixed

- **Bug #2: NULL Values** - `exclude_unset=True` now works after loading from DB
  - `_update_from_db()` preserves original `__pydantic_fields_set__`
  - Subsequent saves don't include DB-loaded fields as user-set

- **Bug #7: save() Returns New Instance** - Now updates original instance
  - `save()` updates `self` attributes in place instead of returning new object
  - Uses `_update_from_db()` for consistent field handling

- **Bug #8: datetime Serialization for UPDATE** - Fixed via `server_fields`
  - Server-generated datetime fields excluded from save operations
  - No more "expected datetime" errors on second save

- **Bug #9: merge() Returns None** - Now returns `self`
  - `merge()` method signature updated to return `Self`
  - Updates local instance with merged data before returning

### Changed

- **`save()` Uses Upsert** - Idempotent behavior for existing records
  - When ID is set, `save()` now uses `upsert` instead of `create`
  - No more "record already exists" errors on duplicate saves
  - **Breaking:** save() with duplicate ID now updates instead of failing

- Version bump to 0.5.3

---

## [0.5.2] - 2026-02-01

### Added

- **FieldType Enum Improvements** - Enhanced type system for migrations
  - Added `NUMBER`, `SET`, `REGEX` types to `FieldType` enum
  - `generic(inner_type)` method for parameterized types (`array<string>`, `record<users>`)
  - `from_python_type(type)` class method for automatic type mapping
  - Comprehensive docstrings with SurrealDB type documentation

- **Migration Type Validation** - Strict type checking for field definitions
  - `AddField` and `AlterField` now accept `FieldType | str`
  - Validation rejects invalid type strings
  - Support for generic types and union types

### Fixed

- **datetime Serialization** (Bug #1) - Custom JSON encoder for RPC requests
  - `SurrealJSONEncoder` handles `datetime`, `date`, `time`, `Decimal`, `UUID`
  - HTTP connection now uses pre-encoded JSON to preserve custom types

- **NULL Values Override** (Bug #2) - Optional fields no longer override DB defaults
  - Changed `model_dump()` to use `exclude_unset=True` in save/update operations
  - Unset optional fields are not sent to the database

- **Fluent API** (Bug #3) - `connect()` now returns `Self` for method chaining
  - `HTTPConnection.connect()` and `WebSocketConnection.connect()` return `self`
  - Enables patterns like `await (await conn.connect()).signin(...)`

- **Session Cleanup** (Bug #5) - WebSocket callback tasks properly managed
  - Added `_callback_tasks` set to track active tasks
  - Tasks are cancelled and cleared in `_cleanup()` method

- **Parameter Alias** (Bug #4) - `username` alias for `user` parameter
  - `SurrealDBConnectionManager.set_connection()` accepts both `user` and `username`
  - Raises `ValueError` if neither is provided

- **Patch Version Increment** - Fixed version calculation for security patches
  - Now extracts semantic base version (x.y.z) from current version
  - Correctly increments to x.y.z.1, x.y.z.2, etc. instead of x.y.z.1.1

### Changed

- Version bump to 0.5.2

---

## [0.5.1] - 2026-02-01

### Added

- **Dependabot Security Workflows** - Automated dependency updates
  - Auto-merge for Dependabot PRs after CI passes
  - Patch version tagging (x.x.x.1, x.x.x.2, etc.) for security updates
  - Automatic GitHub releases for security patches

- **SurrealDB Security Monitoring** - Database vulnerability tracking
  - Daily checks for new SurrealDB releases
  - Automatic integration tests with new DB versions
  - Auto-update of DB requirements on security patches
  - Issue creation for compatibility failures

### Changed

- Version bump to 0.5.1

---

## [0.5.0] - 2026-02-01

### Added

- **Live Select Stream** - Async iterator pattern for real-time change notifications
  - `LiveSelectStream` class with `async with` context manager and `async for` iteration
  - `LiveChange` dataclass with `record_id`, `action`, `result`, `changed_fields`
  - `LiveAction` enum: `CREATE`, `UPDATE`, `DELETE`
  - WHERE clause support with parameterized queries
  - DIFF mode support for receiving only changed fields

- **Live Select Manager** - Callback-based multi-stream management
  - `LiveSelectManager` for managing multiple concurrent subscriptions
  - `watch(table, callback, where, params)` method for callback-based watching
  - `stop(live_id)` and `stop_all()` for subscription management
  - `active_streams` and `count` properties

- **Auto-Resubscribe** - Automatic Live Query reconnection
  - `auto_resubscribe` parameter for automatic reconnection after WebSocket disconnect
  - `LiveSubscriptionParams` dataclass for storing subscription state
  - `on_reconnect(old_id, new_id)` callback for resubscription notifications
  - Seamless recovery on K8s pod restarts and network interruptions

- **Typed Function Calls** - Pydantic/dataclass return type support
  - `call(function, params, return_type)` method on connections
  - Automatic conversion to Pydantic models and dataclasses
  - `fn::` prefix auto-normalization for user-defined functions
  - Support for built-in function namespaces (math::, time::, etc.)

### Changed

- Version bump to 0.5.0
- SDK `__init__.py` updated with new exports

---

## [0.4.0] - 2026-02-01

### Added

- **Relation Field Types** - Declarative relation definitions
  - `ForeignKey(to, on_delete, related_name)` - Single record reference
  - `ManyToMany(to, through, related_name)` - Multiple record reference
  - `Relation(edge, to, reverse)` - SurrealDB graph edges

- **Relation Operations** - Django-style relation management
  - `RelationManager` class for lazy loading and operations
  - `add(*objects)`, `remove(*objects)`, `set(objects)`, `clear()` methods
  - `all()`, `filter(**kwargs)`, `count()`, `contains(obj)` query methods

- **Graph Traversal** - SurrealDB graph capabilities
  - `RelationQuerySet` for chained multi-hop traversal
  - `graph_query(traversal)` for raw graph queries on QuerySet
  - `traverse(path)` method for graph path queries

- **Prefetch Related** - N+1 query prevention
  - `select_related(*relations)` - Eager load in same query
  - `prefetch_related(*relations)` - Separate optimized queries

- **Model Methods** - Low-level graph operations
  - `relate(relation, to, tx, **edge_data)` - Create graph edge
  - `remove_relation(relation, to, tx)` - Delete graph edge
  - `get_related(relation, direction, model_class)` - Query edges

- **Relation Helpers**
  - `is_relation_field()`, `is_foreign_key()`, `is_many_to_many()`, `is_graph_relation()`
  - `get_relation_info()` for metadata extraction
  - `RelationInfo` dataclass for relation metadata

### Changed

- Version bump to 0.4.0

---

## [0.3.1] - 2026-02-01

### Added

- **Bulk Operations** - Efficient batch operations
  - `bulk_create(instances, atomic=False, batch_size=None)` - Create multiple records
  - `bulk_update(data, atomic=False)` - Update matching records
  - `bulk_delete(atomic=False)` - Delete matching records
  - Transaction support with `atomic=True` for all-or-nothing operations

### Fixed

- ORDER BY clause position (now correctly placed before LIMIT/START in SurrealQL)
- Typo in error message: "primirary_key" corrected to "primary_key"

---

## [0.3.0] - 2026-02-01

### Added

- **ORM Transactions** - Transaction support integrated into ORM layer
  - `tx` parameter added to `save()`, `update()`, `merge()`, `delete()` methods
  - `Model.transaction()` class method shortcut for creating transactions
  - `SurrealDBConnectionManager.transaction()` context manager

- **Aggregations** - Django-style aggregation classes
  - `Count()` - Count records
  - `Sum(field)` - Sum field values
  - `Avg(field)` - Average field values
  - `Min(field)` - Minimum field value
  - `Max(field)` - Maximum field value

- **GROUP BY Support**
  - `values(*fields)` method for specifying GROUP BY fields
  - `annotate(**aggregations)` method for computed aggregations
  - GROUP ALL behavior when `annotate()` used without `values()`

- **QuerySet Aggregation Methods**
  - `count()` - Count matching records
  - `sum(field)` - Sum field values
  - `avg(field)` - Average field values
  - `min(field)` - Minimum field value
  - `max(field)` - Maximum field value

### Changed

- Version bump to 0.3.0

---

## [0.2.2] - 2026-02-01

### Added

- **Atomic Transactions** - Full transaction support with context manager
  - `HTTPTransaction` - Batched execution for stateless connections
  - `WebSocketTransaction` - Immediate execution with server-side transactions
  - Context manager with auto-commit on success, auto-rollback on exception
  - Transaction methods: `query()`, `create()`, `update()`, `delete()`, `relate()`
  - `TransactionError` exception with rollback status tracking

- **Typed Functions API** - Fluent interface for SurrealDB functions
  - `db.fn.namespace.function()` syntax for built-in functions
  - `db.fn.custom_function()` syntax for user-defined functions
  - Support for all built-in namespaces: `array`, `crypto`, `duration`, `geo`, `http`, `math`, `meta`, `object`, `parse`, `rand`, `session`, `string`, `time`, `type`, `vector`
  - Automatic parameter binding with variable namespacing

- **Test Infrastructure Improvements**
  - Automatic SurrealDB container lifecycle management in `conftest.py`
  - Container detection to avoid duplicate instances
  - Graceful container cleanup only when started by tests

### Changed

- Test coverage improved to 68.5%
- Updated SDK documentation with transactions and functions guides

### Fixed

- Mypy `no-any-return` errors in `functions.py`
- Unused imports and variables in test files
- Module path resolution for SDK exceptions in tests

---

## [0.2.1] - 2026-02-01

### Added

- **Django-style Migration System** - Complete migration framework for schema versioning
  - `MigrationGenerator` - Generates Python migration files from model changes
  - `MigrationExecutor` - Applies/rolls back migrations to database
  - `ModelIntrospector` - Extracts schema state from Pydantic models
  - `SchemaState` with diff algorithm to compute operations between states
  - Migration operations: `CreateTable`, `DropTable`, `AddField`, `DropField`, `AlterField`, `CreateIndex`, `DropIndex`, `DefineAccess`, `RemoveAccess`, `DataMigration`, `RawSQL`

- **CLI for Schema Management** (`surreal-orm` command, requires `pip install surrealdb-orm[cli]`)
  - `makemigrations` - Generate migration files from model changes
  - `migrate` - Apply pending schema migrations
  - `upgrade` - Apply data migrations (record transformations)
  - `rollback <target>` - Rollback to a specific migration
  - `status` - Show migration status
  - `sqlmigrate <migration>` - Show SQL without executing
  - `shell` - Interactive SurrealQL shell

- **Table Type Classification** (`TableType` enum)
  - `NORMAL` - Standard table (default)
  - `USER` - Authentication table (enforces SCHEMAFULL, generates DEFINE ACCESS)
  - `STREAM` - Real-time table with CHANGEFEED
  - `HASH` - Lookup/cache table (defaults to SCHEMALESS)

- **Encrypted Field Type** for password hashing
  - `Encrypted` - Type alias for encrypted string fields
  - `EncryptedField(algorithm)` - Factory for custom encryption algorithms
  - Supported algorithms: `argon2` (default), `bcrypt`, `pbkdf2`, `scrypt`
  - Auto-generates `crypto::<algorithm>::generate()` in schema

- **JWT Authentication Support** using SurrealDB's `DEFINE ACCESS ... TYPE RECORD`
  - `AuthenticatedUserMixin` - Mixin providing `signup()`, `signin()`, `authenticate_token()`, `change_password()`
  - `AccessDefinition` - Dataclass for access configuration
  - `AccessGenerator` - Generates DEFINE ACCESS from USER models
  - Configurable token/session durations

- **Extended Model Configuration** (`SurrealConfigDict`)
  - `table_type` - USER, STREAM, HASH, NORMAL
  - `schema_mode` - SCHEMAFULL / SCHEMALESS
  - `changefeed` - Duration string (e.g., "7d")
  - `permissions` - Row-level security expressions
  - `identifier_field` - Field for signin (default: "email")
  - `password_field` - Field for password (default: "password")
  - `token_duration` / `session_duration` - JWT lifetimes

- **Model Registry** - Auto-registration of models via `__init_subclass__`
  - `get_registered_models()` - Get all registered model classes
  - `clear_model_registry()` - Clear for testing

- **New Test Suites**
  - `test_types.py` - Tests for enums (14 tests)
  - `test_encrypted_field.py` - Tests for Encrypted type (18 tests)
  - `test_migrations_operations.py` - Tests for operations (40 tests)
  - `test_migrations_state.py` - Tests for state/diff (25 tests)
  - `test_migrations_introspector.py` - Tests for introspection (15 tests)
  - `test_migrations_generator.py` - Tests for file generation (17 tests)
  - `test_cli.py` - CLI command tests (21 tests)
  - `test_auth_unit.py` - Auth unit tests (37 tests)
  - `test_migrations_integration.py` - Integration tests (requires SurrealDB)
  - `test_auth_integration.py` - Auth integration tests (requires SurrealDB)

### Changed

- Test coverage improved from ~44% to 56%
- Added `click>=8.1.0` as optional dependency for CLI

### Fixed

- Mypy type errors in auth mixins and migration modules
- Ruff linting issues across codebase
- Dataclass property override issue in `AlterField` operation

---

## [0.2.0] - 2026-02-01

### Added

- **New `surreal_sdk` package** - Standalone SDK that can be published separately to PyPI as `surreal-sdk`
  - Has its own `pyproject.toml` and `README.md`
  - Can be installed independently: `pip install surreal-sdk`

- **New `surreal_sdk` module** - Custom Python SDK for SurrealDB independent of the official `surrealdb` package
  - `HTTPConnection` - Stateless HTTP-based connection, ideal for microservices and serverless
  - `WebSocketConnection` - Stateful WebSocket connection for real-time features and Live Queries
  - `ConnectionPool` - Connection pooling for high-throughput scenarios
  - `LiveQuery` and `LiveQueryManager` - Real-time Live Query subscriptions (WebSocket only)
  - `ChangeFeedStream` and `MultiTableChangeFeed` - CDC pattern for stateless microservices (HTTP)
  - `RPCRequest`, `RPCResponse`, `RPCError` - RPC protocol layer

- **Strongly-typed response classes** (replacing `Any` returns)
  - `QueryResponse` / `QueryResult` - For query operations
  - `RecordResponse` / `RecordsResponse` - For record CRUD operations
  - `AuthResponse` - For signin/signup authentication
  - `InfoResponse` - For database info operations
  - `DeleteResponse` - For delete operations
  - `LiveQueryId` - For live query UUID handling
  - `ResponseStatus` - Enum for OK/ERR status

- **Exception classes** for SDK
  - `SurrealDBError`, `ConnectionError`, `AuthenticationError`
  - `QueryError`, `TimeoutError`, `LiveQueryError`, `ChangeFeedError`

### Changed

- **ðŸš€ ORM now uses custom SDK** - Removed dependency on official `surrealdb` package
  - `SurrealDBConnectionManager` now uses `HTTPConnection` from `surreal_sdk`
  - All ORM methods adapted to use typed responses (`RecordResponse`, `RecordsResponse`, etc.)
  - Removed `surrealdb>=0.4.1` from dependencies

- **Python version support**: Now requires Python 3.12+ (dropped 3.11, added 3.14)
- Updated `pyproject.toml` classifiers and tool configurations for Python 3.12/3.13/3.14
- Coverage threshold reduced to 35% to accommodate new SDK code

### Removed

- **Dependency on `surrealdb` package** - No longer required, fully replaced by custom `surreal_sdk`

### Fixed

- ID parsing from SurrealDB format (`table:id` â†’ `id`)
- Test isolation with dedicated model classes per test

---

## [0.1.5] - 2025-01-20

- Add
  - Support Model.DoesNotExist Error

## [0.1.4] - 2025-01-20

- Improvement
  - New class init based on the pydantic 2.0 validators.

- Changed
  - Required id or primary_key model_config

- Fixed
  - Packaging setup.
  - Pydantic validators can be uses on the class
  - Error message on primary key with use of SurrealConfigDict

---

## [0.1.3] - 2025-01-07

- Fixed
  - Packaging fix.

---

## [0.1.0] - 2025-01-07

- Added
  - Init version with basic "Django" like ORM.
  - Basic test and standard form has been set.

---
*Format based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/) and compliant with [SemVer](https://semver.org/).*

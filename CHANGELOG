# Changelog

All notable changes to this project will be documented in this file.
This file follows the [Keep a Changelog](https://keepachangelog.com/en/1.0.0/) format
and adheres to [SemVer](https://semver.org/) versioning.

---

## [0.5.3] - 2026-02-02

### Added

- **`upsert()` Method** - New SDK method for create-or-update operations
  - Added to `BaseSurrealConnection` and all transaction types
  - Enables idempotent save behavior for existing records

- **`server_fields` Config Option** - Exclude server-generated fields from saves
  - New `server_fields` option in `SurrealConfigDict`
  - Automatically excludes fields like `created_at`, `updated_at` from save/update
  - Prevents datetime serialization errors on subsequent saves

- **`_update_from_db()` Helper** - Internal method for DB data loading
  - Updates model fields without marking them as user-set
  - Preserves `__pydantic_fields_set__` for correct `exclude_unset` behavior

### Fixed

- **Bug #2: NULL Values** - `exclude_unset=True` now works after loading from DB
  - `_update_from_db()` preserves original `__pydantic_fields_set__`
  - Subsequent saves don't include DB-loaded fields as user-set

- **Bug #7: save() Returns New Instance** - Now updates original instance
  - `save()` updates `self` attributes in place instead of returning new object
  - Uses `_update_from_db()` for consistent field handling

- **Bug #8: datetime Serialization for UPDATE** - Fixed via `server_fields`
  - Server-generated datetime fields excluded from save operations
  - No more "expected datetime" errors on second save

- **Bug #9: merge() Returns None** - Now returns `self`
  - `merge()` method signature updated to return `Self`
  - Updates local instance with merged data before returning

### Changed

- **`save()` Uses Upsert** - Idempotent behavior for existing records
  - When ID is set, `save()` now uses `upsert` instead of `create`
  - No more "record already exists" errors on duplicate saves
  - **Breaking:** save() with duplicate ID now updates instead of failing

- Version bump to 0.5.3

---

## [0.5.2] - 2026-02-01

### Added

- **FieldType Enum Improvements** - Enhanced type system for migrations
  - Added `NUMBER`, `SET`, `REGEX` types to `FieldType` enum
  - `generic(inner_type)` method for parameterized types (`array<string>`, `record<users>`)
  - `from_python_type(type)` class method for automatic type mapping
  - Comprehensive docstrings with SurrealDB type documentation

- **Migration Type Validation** - Strict type checking for field definitions
  - `AddField` and `AlterField` now accept `FieldType | str`
  - Validation rejects invalid type strings
  - Support for generic types and union types

### Fixed

- **datetime Serialization** (Bug #1) - Custom JSON encoder for RPC requests
  - `SurrealJSONEncoder` handles `datetime`, `date`, `time`, `Decimal`, `UUID`
  - HTTP connection now uses pre-encoded JSON to preserve custom types

- **NULL Values Override** (Bug #2) - Optional fields no longer override DB defaults
  - Changed `model_dump()` to use `exclude_unset=True` in save/update operations
  - Unset optional fields are not sent to the database

- **Fluent API** (Bug #3) - `connect()` now returns `Self` for method chaining
  - `HTTPConnection.connect()` and `WebSocketConnection.connect()` return `self`
  - Enables patterns like `await (await conn.connect()).signin(...)`

- **Session Cleanup** (Bug #5) - WebSocket callback tasks properly managed
  - Added `_callback_tasks` set to track active tasks
  - Tasks are cancelled and cleared in `_cleanup()` method

- **Parameter Alias** (Bug #4) - `username` alias for `user` parameter
  - `SurrealDBConnectionManager.set_connection()` accepts both `user` and `username`
  - Raises `ValueError` if neither is provided

- **Patch Version Increment** - Fixed version calculation for security patches
  - Now extracts semantic base version (x.y.z) from current version
  - Correctly increments to x.y.z.1, x.y.z.2, etc. instead of x.y.z.1.1

### Changed

- Version bump to 0.5.2

---

## [0.5.1] - 2026-02-01

### Added

- **Dependabot Security Workflows** - Automated dependency updates
  - Auto-merge for Dependabot PRs after CI passes
  - Patch version tagging (x.x.x.1, x.x.x.2, etc.) for security updates
  - Automatic GitHub releases for security patches

- **SurrealDB Security Monitoring** - Database vulnerability tracking
  - Daily checks for new SurrealDB releases
  - Automatic integration tests with new DB versions
  - Auto-update of DB requirements on security patches
  - Issue creation for compatibility failures

### Changed

- Version bump to 0.5.1

---

## [0.5.0] - 2026-02-01

### Added

- **Live Select Stream** - Async iterator pattern for real-time change notifications
  - `LiveSelectStream` class with `async with` context manager and `async for` iteration
  - `LiveChange` dataclass with `record_id`, `action`, `result`, `changed_fields`
  - `LiveAction` enum: `CREATE`, `UPDATE`, `DELETE`
  - WHERE clause support with parameterized queries
  - DIFF mode support for receiving only changed fields

- **Live Select Manager** - Callback-based multi-stream management
  - `LiveSelectManager` for managing multiple concurrent subscriptions
  - `watch(table, callback, where, params)` method for callback-based watching
  - `stop(live_id)` and `stop_all()` for subscription management
  - `active_streams` and `count` properties

- **Auto-Resubscribe** - Automatic Live Query reconnection
  - `auto_resubscribe` parameter for automatic reconnection after WebSocket disconnect
  - `LiveSubscriptionParams` dataclass for storing subscription state
  - `on_reconnect(old_id, new_id)` callback for resubscription notifications
  - Seamless recovery on K8s pod restarts and network interruptions

- **Typed Function Calls** - Pydantic/dataclass return type support
  - `call(function, params, return_type)` method on connections
  - Automatic conversion to Pydantic models and dataclasses
  - `fn::` prefix auto-normalization for user-defined functions
  - Support for built-in function namespaces (math::, time::, etc.)

### Changed

- Version bump to 0.5.0
- SDK `__init__.py` updated with new exports

---

## [0.4.0] - 2026-02-01

### Added

- **Relation Field Types** - Declarative relation definitions
  - `ForeignKey(to, on_delete, related_name)` - Single record reference
  - `ManyToMany(to, through, related_name)` - Multiple record reference
  - `Relation(edge, to, reverse)` - SurrealDB graph edges

- **Relation Operations** - Django-style relation management
  - `RelationManager` class for lazy loading and operations
  - `add(*objects)`, `remove(*objects)`, `set(objects)`, `clear()` methods
  - `all()`, `filter(**kwargs)`, `count()`, `contains(obj)` query methods

- **Graph Traversal** - SurrealDB graph capabilities
  - `RelationQuerySet` for chained multi-hop traversal
  - `graph_query(traversal)` for raw graph queries on QuerySet
  - `traverse(path)` method for graph path queries

- **Prefetch Related** - N+1 query prevention
  - `select_related(*relations)` - Eager load in same query
  - `prefetch_related(*relations)` - Separate optimized queries

- **Model Methods** - Low-level graph operations
  - `relate(relation, to, tx, **edge_data)` - Create graph edge
  - `remove_relation(relation, to, tx)` - Delete graph edge
  - `get_related(relation, direction, model_class)` - Query edges

- **Relation Helpers**
  - `is_relation_field()`, `is_foreign_key()`, `is_many_to_many()`, `is_graph_relation()`
  - `get_relation_info()` for metadata extraction
  - `RelationInfo` dataclass for relation metadata

### Changed

- Version bump to 0.4.0

---

## [0.3.1] - 2026-02-01

### Added

- **Bulk Operations** - Efficient batch operations
  - `bulk_create(instances, atomic=False, batch_size=None)` - Create multiple records
  - `bulk_update(data, atomic=False)` - Update matching records
  - `bulk_delete(atomic=False)` - Delete matching records
  - Transaction support with `atomic=True` for all-or-nothing operations

### Fixed

- ORDER BY clause position (now correctly placed before LIMIT/START in SurrealQL)
- Typo in error message: "primirary_key" corrected to "primary_key"

---

## [0.3.0] - 2026-02-01

### Added

- **ORM Transactions** - Transaction support integrated into ORM layer
  - `tx` parameter added to `save()`, `update()`, `merge()`, `delete()` methods
  - `Model.transaction()` class method shortcut for creating transactions
  - `SurrealDBConnectionManager.transaction()` context manager

- **Aggregations** - Django-style aggregation classes
  - `Count()` - Count records
  - `Sum(field)` - Sum field values
  - `Avg(field)` - Average field values
  - `Min(field)` - Minimum field value
  - `Max(field)` - Maximum field value

- **GROUP BY Support**
  - `values(*fields)` method for specifying GROUP BY fields
  - `annotate(**aggregations)` method for computed aggregations
  - GROUP ALL behavior when `annotate()` used without `values()`

- **QuerySet Aggregation Methods**
  - `count()` - Count matching records
  - `sum(field)` - Sum field values
  - `avg(field)` - Average field values
  - `min(field)` - Minimum field value
  - `max(field)` - Maximum field value

### Changed

- Version bump to 0.3.0

---

## [0.2.2] - 2026-02-01

### Added

- **Atomic Transactions** - Full transaction support with context manager
  - `HTTPTransaction` - Batched execution for stateless connections
  - `WebSocketTransaction` - Immediate execution with server-side transactions
  - Context manager with auto-commit on success, auto-rollback on exception
  - Transaction methods: `query()`, `create()`, `update()`, `delete()`, `relate()`
  - `TransactionError` exception with rollback status tracking

- **Typed Functions API** - Fluent interface for SurrealDB functions
  - `db.fn.namespace.function()` syntax for built-in functions
  - `db.fn.custom_function()` syntax for user-defined functions
  - Support for all built-in namespaces: `array`, `crypto`, `duration`, `geo`, `http`, `math`, `meta`, `object`, `parse`, `rand`, `session`, `string`, `time`, `type`, `vector`
  - Automatic parameter binding with variable namespacing

- **Test Infrastructure Improvements**
  - Automatic SurrealDB container lifecycle management in `conftest.py`
  - Container detection to avoid duplicate instances
  - Graceful container cleanup only when started by tests

### Changed

- Test coverage improved to 68.5%
- Updated SDK documentation with transactions and functions guides

### Fixed

- Mypy `no-any-return` errors in `functions.py`
- Unused imports and variables in test files
- Module path resolution for SDK exceptions in tests

---

## [0.2.1] - 2026-02-01

### Added

- **Django-style Migration System** - Complete migration framework for schema versioning
  - `MigrationGenerator` - Generates Python migration files from model changes
  - `MigrationExecutor` - Applies/rolls back migrations to database
  - `ModelIntrospector` - Extracts schema state from Pydantic models
  - `SchemaState` with diff algorithm to compute operations between states
  - Migration operations: `CreateTable`, `DropTable`, `AddField`, `DropField`, `AlterField`, `CreateIndex`, `DropIndex`, `DefineAccess`, `RemoveAccess`, `DataMigration`, `RawSQL`

- **CLI for Schema Management** (`surreal-orm` command, requires `pip install surrealdb-orm[cli]`)
  - `makemigrations` - Generate migration files from model changes
  - `migrate` - Apply pending schema migrations
  - `upgrade` - Apply data migrations (record transformations)
  - `rollback <target>` - Rollback to a specific migration
  - `status` - Show migration status
  - `sqlmigrate <migration>` - Show SQL without executing
  - `shell` - Interactive SurrealQL shell

- **Table Type Classification** (`TableType` enum)
  - `NORMAL` - Standard table (default)
  - `USER` - Authentication table (enforces SCHEMAFULL, generates DEFINE ACCESS)
  - `STREAM` - Real-time table with CHANGEFEED
  - `HASH` - Lookup/cache table (defaults to SCHEMALESS)

- **Encrypted Field Type** for password hashing
  - `Encrypted` - Type alias for encrypted string fields
  - `EncryptedField(algorithm)` - Factory for custom encryption algorithms
  - Supported algorithms: `argon2` (default), `bcrypt`, `pbkdf2`, `scrypt`
  - Auto-generates `crypto::<algorithm>::generate()` in schema

- **JWT Authentication Support** using SurrealDB's `DEFINE ACCESS ... TYPE RECORD`
  - `AuthenticatedUserMixin` - Mixin providing `signup()`, `signin()`, `authenticate_token()`, `change_password()`
  - `AccessDefinition` - Dataclass for access configuration
  - `AccessGenerator` - Generates DEFINE ACCESS from USER models
  - Configurable token/session durations

- **Extended Model Configuration** (`SurrealConfigDict`)
  - `table_type` - USER, STREAM, HASH, NORMAL
  - `schema_mode` - SCHEMAFULL / SCHEMALESS
  - `changefeed` - Duration string (e.g., "7d")
  - `permissions` - Row-level security expressions
  - `identifier_field` - Field for signin (default: "email")
  - `password_field` - Field for password (default: "password")
  - `token_duration` / `session_duration` - JWT lifetimes

- **Model Registry** - Auto-registration of models via `__init_subclass__`
  - `get_registered_models()` - Get all registered model classes
  - `clear_model_registry()` - Clear for testing

- **New Test Suites**
  - `test_types.py` - Tests for enums (14 tests)
  - `test_encrypted_field.py` - Tests for Encrypted type (18 tests)
  - `test_migrations_operations.py` - Tests for operations (40 tests)
  - `test_migrations_state.py` - Tests for state/diff (25 tests)
  - `test_migrations_introspector.py` - Tests for introspection (15 tests)
  - `test_migrations_generator.py` - Tests for file generation (17 tests)
  - `test_cli.py` - CLI command tests (21 tests)
  - `test_auth_unit.py` - Auth unit tests (37 tests)
  - `test_migrations_integration.py` - Integration tests (requires SurrealDB)
  - `test_auth_integration.py` - Auth integration tests (requires SurrealDB)

### Changed

- Test coverage improved from ~44% to 56%
- Added `click>=8.1.0` as optional dependency for CLI

### Fixed

- Mypy type errors in auth mixins and migration modules
- Ruff linting issues across codebase
- Dataclass property override issue in `AlterField` operation

---

## [0.2.0] - 2026-02-01

### Added

- **New `surreal_sdk` package** - Standalone SDK that can be published separately to PyPI as `surreal-sdk`
  - Has its own `pyproject.toml` and `README.md`
  - Can be installed independently: `pip install surreal-sdk`

- **New `surreal_sdk` module** - Custom Python SDK for SurrealDB independent of the official `surrealdb` package
  - `HTTPConnection` - Stateless HTTP-based connection, ideal for microservices and serverless
  - `WebSocketConnection` - Stateful WebSocket connection for real-time features and Live Queries
  - `ConnectionPool` - Connection pooling for high-throughput scenarios
  - `LiveQuery` and `LiveQueryManager` - Real-time Live Query subscriptions (WebSocket only)
  - `ChangeFeedStream` and `MultiTableChangeFeed` - CDC pattern for stateless microservices (HTTP)
  - `RPCRequest`, `RPCResponse`, `RPCError` - RPC protocol layer

- **Strongly-typed response classes** (replacing `Any` returns)
  - `QueryResponse` / `QueryResult` - For query operations
  - `RecordResponse` / `RecordsResponse` - For record CRUD operations
  - `AuthResponse` - For signin/signup authentication
  - `InfoResponse` - For database info operations
  - `DeleteResponse` - For delete operations
  - `LiveQueryId` - For live query UUID handling
  - `ResponseStatus` - Enum for OK/ERR status

- **Exception classes** for SDK
  - `SurrealDBError`, `ConnectionError`, `AuthenticationError`
  - `QueryError`, `TimeoutError`, `LiveQueryError`, `ChangeFeedError`

### Changed

- **ðŸš€ ORM now uses custom SDK** - Removed dependency on official `surrealdb` package
  - `SurrealDBConnectionManager` now uses `HTTPConnection` from `surreal_sdk`
  - All ORM methods adapted to use typed responses (`RecordResponse`, `RecordsResponse`, etc.)
  - Removed `surrealdb>=0.4.1` from dependencies

- **Python version support**: Now requires Python 3.12+ (dropped 3.11, added 3.14)
- Updated `pyproject.toml` classifiers and tool configurations for Python 3.12/3.13/3.14
- Coverage threshold reduced to 35% to accommodate new SDK code

### Removed

- **Dependency on `surrealdb` package** - No longer required, fully replaced by custom `surreal_sdk`

### Fixed

- ID parsing from SurrealDB format (`table:id` â†’ `id`)
- Test isolation with dedicated model classes per test

---

## [0.1.5] - 2025-01-20

- Add
  - Support Model.DoesNotExist Error

## [0.1.4] - 2025-01-20

- Improvement
  - New class init based on the pydantic 2.0 validators.

- Changed
  - Required id or primary_key model_config

- Fixed
  - Packaging setup.
  - Pydantic validators can be uses on the class
  - Error message on primary key with use of SurrealConfigDict

---

## [0.1.3] - 2025-01-07

- Fixed
  - Packaging fix.

---

## [0.1.0] - 2025-01-07

- Added
  - Init version with basic "Django" like ORM.
  - Basic test and standard form has been set.

---
*Format based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/) and compliant with [SemVer](https://semver.org/).*
